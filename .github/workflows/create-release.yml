name: Build Release Package

# This workflow creates a production-ready release package for the Wuunder Shipping plugin
# and deploys it to WordPress.org SVN repository.
#
# Triggers:
# - Push to release branch (builds and attaches package to draft release)
# - Publishing a GitHub release (deploys to SVN)
#
# The workflow:
# 1. Reads version from the main plugin file (wuunder-shipping.php)
# 2. Installs production dependencies (PHP/Node)
# 3. Builds production assets (CSS/JS)
# 4. Creates a distribution package excluding development files (via .distignore)
# 5. Generates SHA256 checksum for security
# 6. Uploads the package to GitHub release (on both draft and publish)
# 7. Deploys to WordPress.org SVN (only when published)

on:
  push:
    branches:
      - release  # Triggers when code is merged to release branch
  release:
    types: [published]  # Triggers when release is published for SVN deployment
  workflow_dispatch:  # Allows manual triggering to attach zip to existing draft

permissions:
  contents: write  # Required for creating releases

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version from plugin file
        id: get_version
        run: |
          # Extract version from the plugin header comment
          # This ensures consistency - the plugin file is the single source of truth
          VERSION=$(grep "Version:" wuunder-shipping.php | sed 's/.*Version: //' | tr -d ' ')
          TAG_NAME="v${VERSION}"
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Building release for version: $VERSION"

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
          tools: composer:v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup WP-CLI with dist-archive
        run: |
          # Download and install WP-CLI
          curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
          chmod +x wp-cli.phar
          sudo mv wp-cli.phar /usr/local/bin/wp
          
          # Install the dist-archive package for creating distribution packages
          wp package install wp-cli/dist-archive-command --allow-root

      - name: Install dependencies and build assets
        run: |
          # Install production PHP dependencies (excludes dev dependencies)
          composer install --no-dev --optimize-autoloader
          
          # Install Node dependencies and build production assets
          npm ci
          
          # Build production CSS/JS and generate translation files
          # WP_CLI_ALLOW_ROOT=1 allows wp i18n commands in the build script
          WP_CLI_ALLOW_ROOT=1 npm run build

      - name: Create distribution package
        run: |
          PLUGIN_NAME="wuunder-shipping"
          VERSION="${{ steps.get_version.outputs.version }}"
          
          # Create a distribution archive using WP-CLI
          # - Uses .distignore to exclude development files
          # - Sets the plugin directory name inside the zip
          # - Creates a properly formatted WordPress plugin package
          wp dist-archive . "./${PLUGIN_NAME}-${VERSION}.zip" \
            --plugin-dirname="${PLUGIN_NAME}" \
            --allow-root
          
          # Generate SHA256 checksum for security verification
          sha256sum "${PLUGIN_NAME}-${VERSION}.zip" > "${PLUGIN_NAME}-${VERSION}.zip.sha256"

      - name: Upload assets to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          TAG_NAME="v${VERSION}"

          # Retry logic: wait for Release Drafter to create the draft
          MAX_ATTEMPTS=12
          ATTEMPT=0

          echo "üîç Looking for release $TAG_NAME..."

          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if gh release view "$TAG_NAME" >/dev/null 2>&1; then
              echo "‚úÖ Found release $TAG_NAME"
              echo "üì¶ Uploading assets..."
              gh release upload "$TAG_NAME" wuunder-shipping-*.zip wuunder-shipping-*.zip.sha256 --clobber
              echo "‚úÖ Assets uploaded successfully"
              exit 0
            fi

            ATTEMPT=$((ATTEMPT + 1))
            echo "‚è≥ Attempt $ATTEMPT/$MAX_ATTEMPTS - Release not found yet, waiting..."
            sleep 5
          done

          echo "‚ùå Release $TAG_NAME not found after $MAX_ATTEMPTS attempts"
          echo "Please check if Release Drafter workflow completed successfully"
          exit 1

      - name: Prepare for SVN deployment
        if: github.event.action == 'published'
        run: |
          PLUGIN_NAME="wuunder-shipping"
          VERSION="${{ steps.get_version.outputs.version }}"
          
          # Extract the built package for SVN deployment
          unzip -q "${PLUGIN_NAME}-${VERSION}.zip" -d ./svn-deploy
          
          # Prepare WordPress.org assets directory
          mkdir -p .wordpress-org
          
          # Copy WordPress.org assets if they exist
          if [ -d "assets/wordpress-org" ]; then
            cp -r assets/wordpress-org/* .wordpress-org/ 2>/dev/null || true
          fi
          
          echo "Prepared for SVN deployment"

      - name: Check SVN repository exists
        if: github.event.action == 'published'
        id: check_svn
        run: |
          # Check if the SVN repository exists
          if curl -s --head "https://plugins.svn.wordpress.org/wuunder-shipping/" | head -n 1 | grep -q "200 OK"; then
            echo "svn_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ SVN repository exists"
          else
            echo "svn_exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è SVN repository does not exist yet - plugin not approved/published on WordPress.org"
            echo "This is expected for new plugins before WordPress.org approval"
          fi

      - name: Deploy to WordPress.org SVN
        if: github.event.action == 'published' && steps.check_svn.outputs.svn_exists == 'true'
        uses: 10up/action-wordpress-plugin-deploy@stable
        with:
          dry-run: true
        env:
          SVN_USERNAME: ${{ secrets.SVN_USERNAME || 'dummy' }}
          SVN_PASSWORD: ${{ secrets.SVN_PASSWORD || 'dummy' }}
          SLUG: wuunder-shipping
          VERSION: ${{ steps.get_version.outputs.version }}
          BUILD_DIR: svn-deploy/wuunder-shipping
          ASSETS_DIR: .wordpress-org